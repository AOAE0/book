





云上应用高可用部署
实验手册












 

华为技术有限公司
  
		目录
1 实验总体介绍	3
1.1 实验总体介绍	3
1.1.1 关于本实验	3
1.1.2 实验目的	3
1.1.3 实验组网介绍	3
1.1.4 实验资源	4
1.1.5 实验工具	4
2 云平台部署OA系统	6
2.1 实验介绍	6
2.1.1 关于本实验	6
2.1.2 实验目的	6
2.2 应用介绍	6
2.3 数据库部署	7
2.3.1 购买华为云RDS数据库	7
2.3.2 导入数据	10
2.4 应用部署	11
2.4.1 购买华为云ECS云服务器	11
2.4.2 安装Maven	14
2.4.3 Maven换源	15
2.4.4 克隆项目	15
2.4.5 配置MySQL连接	15
3 云平台应用高可用部署	18
3.1 实验介绍	18
3.1.1 关于本实验	18
3.1.2 实验目的	18
3.2 配置应用开机启动	18
3.2.1 创建启动脚本	18
3.2.2 自定义开机启动命令	18
3.2.3 验证开机启动	19
3.3 配置弹性负载均衡	20
3.3.1 购买华为云ELB弹性负载均衡	20
3.3.2 配置监听器	21
3.3.3 创建云服务器镜像	24
3.4 配置弹性伸缩	25
3.4.1 购买华为云AS弹性伸缩服务	25
3.4.2 创建伸缩配置	27
3.4.3 添加弹性策略	29
4 释放实验资源	33
4.1 删除云数据库RDS	33
4.2 删除AS弹性伸缩	33
4.3 删除ELB弹性负载均衡	33
4.4 删除ECS弹性云服务器	33
4.5 删除IMS镜像	34
4.6 资源检查	34
5 附录	35
5.1 创建OBS桶	35

 
1 实验总体介绍
1.1 实验总体介绍
1.1.1 关于本实验
本实验将介绍如何在云平台上部署企业自动化办公（Office Automation，简称OA）系统，以及如何在云平台上部署应用的高可靠。
1.1.2 实验目的
	掌握华为云云服务的操作方法；
	完成云平台应用的高可用部署。
1.1.3 实验组网介绍
图1-1 实验一 云平台部署OA系统架构图
 
 
图1-2 实验二高可用部署系统架构图

1.1.4 实验资源
设备名称、型号与版本的对应关系如下：
表1-1 实验设备详细信息
设备名称	设备型号	软件版本
云平台OA系统服务器
ecs-oa 	鲲鹏计算，通用计算增强型，
4vCPUs | 8GiB | kc1.xlarge.2
CentOS 7.6 64bit with ARM 	CentOS 7.6 64bit with ARM
云数据库 RDS for MySQL
rds-oa 	RDS for MySQL，鲲鹏通用增强型，2vCPUs | 4 GB	5.7
1.1.5 实验工具
表1-2 实验工具详细信息
名称	下载链接	用途
WinSCP	https://winscp.net/eng/download.php
远程传输工具
Git	https://git-scm.com/downloads
分布式版本控制系统
Maven	https://mirrors.huaweicloud.com/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz	软件项目管理工具
oasys_mysql	https://gitee.com/github-5407963/oasys_mysql	OA系统项目源代码
oasys_mysql.sql	https://gitee.com/github-5407963/oasys_mysql/blob/master/oasys.sql	OA系统MySQL数据库脚本



















2 云平台部署OA系统
2.1 实验介绍
2.1.1 关于本实验
本实验通过一个开源的OA系统实例，实现OA系统在华为云云服务器上的部署。
2.1.2 实验目的
	掌握应用在华为云云服务器上的部署和配置流程。
	掌握华为云数据库的部署和配置流程。
2.2 应用介绍
办公自动化（Office Automation）系统是面向组织的日常运作和管理，员工及管理者使用频率最高的应用系统，极大提高公司的办公效率。Oasys项目(https://gitee.com/github-5407963/oasys_mysql)是一个开源的OA办公自动化应用，使用Maven进行项目管理，基于Spring Boot框架开发的项目，MySQL底层数据库，前端采用Freemarker模板引擎，Bootstrap作为前端UI框架，集成了JPA、MyBatis等框架。
 
2.3 数据库部署
2.3.1 购买华为云RDS数据库
步骤 1	使用PC上的浏览器访问华为云官网：https://www.huaweicloud.com/?locale=zh-cn，单击页面右上角的“登录”，进入华为云账号登录页面。 
 
步骤 2	单击右下角的“IAM用户登录”，进入华为云IAM用户登录页面。若使用个人账号，则直接在此界面进行“账号登录”。
  
步骤 3	输入账号名，用户名和密码，单击下方的“登录”，登录华为云官网。
 
步骤 4	在华为云首页，单击右上角的“控制台”，进入控制台操作页面。
 
步骤 5	购买RDS
 
 
根据图片参数购买RDS
 
选择vpc和安全组，输入密码，其他选项默认，点击”立即购买“即可。
 
注意：此处需要与后续购买的ECS处于同一vpc下

2.3.2 导入数据
步骤 1	RDS控制台，选择更多-登录，进入mysql
 
记下rds-oa的私网/内网地址，如192.168.1.242
输入密码，测试连接没问题后登录
 
步骤 2	创建数据库oasys
 
步骤 3	导入数据
 
新建任务，拖拽开源项目中oasys.sql进选择框，点击”创建导入任务”即可
 
在导入页面可以看到导入完成情况
 
注：若没有OBS，选择创建即可，请参考附录OBS创建桶
2.4 应用部署
2.4.1 购买华为云ECS云服务器
步骤 1	在华为云首页，单击右上角的“控制台”，进入控制台操作页面。在页面左上角，选择区域“北京四”，点击“创建资源”，创建单击“服务列表”。
 
步骤 2	选择“计算 -> 弹性云服务器ECS”，进入弹性云服务器列表页面。
 
步骤 3	单击页面右上角的“购买弹性云服务器”。
 
步骤 4	进入弹性云服务器的基础配置页面，选择基础配置（按需计费，鲲鹏计算，鲲鹏通用计算增强型，kc1.xlarge.2 4vCPUs | 8GB，Centos 7.6 64bit wit ARM），“存储与备份”保持默认。
 
步骤 5	下拉进入弹性云服务器的网络配置部分，其中网络选择和前面创建RDS云数据库相同的VPC和子网，选择“自动分配ID地址”，安全组选择“sg-FullAccess”，公网带宽选择“按流量计费”和“5”Mbit/s带宽大小。 
 
注意：此处的vpc需与RDS的VPC保持一致。
步骤 6	下拉进入弹性云服务器管理部分，配置如下图所示：
	云服务器名称：ecs-oa
	输入自定义密码，密码需大于8位并带有特殊字符，再次确认密码
  
步骤 7	核对右侧“配置概要”信息无误后，勾选下方的“我已经阅读并同意《华为镜像免责声明》”，如果有企业项目使用下拉框选择企业项目，单击“立即购买”，完成用于部署OA系统的鲲鹏云服务器的购买。
步骤 8	返回弹性云服务器列表页面，查看刚刚购买的弹性云服务器ecs-oa，等待其状态变为“运行中”， 记录其弹性IP地址。
步骤 9	远程登录ECS云服务器，可以使用PuTTY工具，或者在华为云控制台进入到ECS控制台，在服务器列表或服务器实例中选择任一中方式远程登录创建的ECS服务器。
 
2.4.2 安装Maven
步骤 1	执行以下命令，创建Maven安装目录。
[root@ecs-oa ~]# mkdir /usr/local/maven
步骤 2	执行以下命令，切换到Maven安装目录。
[root@ecs-oa ~]# cd /usr/local/maven
步骤 3	执行以下命令，获取Maven二进制包。
[root@ecs-oa maven]# wget http://mirrors.huaweicloud.com/apache/maven/maven-3/3.6.3/binaries/apache-maven-3.6.3-bin.tar.gz
步骤 4	执行以下命令，解压Maven二进制包。
[root@ecs-oa maven]# tar -xvzf apache-maven-3.6.3-bin.tar.gz
步骤 5	执行以下命令，打开环境变量配置文件。
[root@ecs-oa maven]# vim /etc/profile
步骤 6	按“i”进入编辑模式，使用hjkl键或方向键移动光标，在文件最后添加以下代码：
MAVEN_HOME=/usr/local/maven/apache-maven-3.6.3
export PATH=$PATH:$MAVEN_HOME/bin
export MAVEN_HOME
步骤 7	按“Esc”退出编辑模式，输入“:wq”并按回车，保存退出。
步骤 8	执行以下命令，使新增配置生效。
[root@ecs-oa maven]# source /etc/profile
步骤 9	执行以下命令，验证Maven安装。
[root@ecs-oa maven]# mvn -v
Apache Maven 3.6.3 (cecedd343002696d0abb50b32b541b8a6ba2883f)
Maven home: /usr/local/maven/apache-maven-3.6.3
Java version: 1.8.0_242, vendor: Huawei Technologies Co., Ltd, runtime: /usr/lib/jvm/java-1.8.0-openjdk-1.8.0.242.b08-1.h5.oe1.aarch64/jre
Default locale: en_US, platform encoding: UTF-8
OS name: "linux", version: "4.19.90-2003.4.0.0036.oe1.aarch64", arch: "aarch64", family: "unix"
2.4.3 Maven换源
步骤 1	执行以下命令，进入Maven配置文件目录。
[root@ecs-oa maven]# cd /usr/local/maven/apache-maven-3.6.3/conf/
步骤 2	执行以下命令，打开配置文件。
[root@ecs-oa conf]# vim settings.xml
步骤 3	输入”:158”后按回车键，在<mirrors>和</mirrors>中间，插入以下代码。
<mirror>
  <id>mirror</id>
  <mirrorOf>*</mirrorOf>
  <name>cmc-cd-mirror</name>
  <url>https://mirrors.huaweicloud.com/repository/maven/</url>
</mirror>
2.4.4 克隆项目
步骤 1	执行以下命令，安装Git。
[root@ecs-oa conf]# yum install -y git
步骤 2	执行以下命令，验证Git版本。
[root@ecs-oa conf]# git version
步骤 3	执行以下命令，Clone源码到本地。
[root@ecs-oa conf]# cd /home
[root@ecs-oa home]# git clone -b mysql-8 https://gitee.com/github-5407963/oasys_mysql.git
2.4.5 配置MySQL连接
步骤 1	执行以下命令，进入OA系统数据库配置文件目录。
[root@ecs-oa home]# cd /home/oasys_mysql/src/main/resources/
步骤 2	执行以下命令，编辑应用配置文件。
[root@ecs-oa resources]# vim application.properties
步骤 3	修改url、username和password为rds-oa的内网地址、rds-oa的登录用户名和密码，保存文件，退出。
server.port=8088
spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver
spring.datasource.url=jdbc:mysql://192.168.0.200:3306/oasys?autoReconnect=true&useSSL=false&characterEncoding=utf-8&serverTimezone=Hongkong&rewriteBatchedStatements=true&allowPublicKeyRetrieval=true
spring.datasource.username=root
spring.datasource.password=mypassword
** 斜体表示要修改项 **
注：rds-oa的地址在2.3.2步骤1即可看到。
步骤 4	执行以下命令，进入OA系统目录。
[root@ecs-oa resources]# cd /home/oasys_mysql/
步骤 5	执行以下命令，重新Maven本地编译安装。
[root@ecs-oa oasys_mysql]# mvn install
步骤 6	执行以下命令，启动项目应用。
[root@ecs-oa oasys_mysql]# java -jar target/oasys.jar
步骤 7	通过ecs-oa弹性公网IP地址加8088端口访问OA系统登录页，如                 http:// 121.36.103.164:8088/。使用用户名“soli”和密码“123456”登录进入OA系统主界面。
 
 
步骤 8	在PuTTY或其他远程登录界面中按“Ctrl+C”组合键结束Java应用。
 
3 云平台应用高可用部署
3.1 实验介绍
3.1.1 关于本实验
本实验通过使用华为云弹性负载均衡ELB和弹性伸缩AS服务，实现云平台OA系统应用的高可用部署。
3.1.2 实验目的
	了解和使用华为云弹性负载均衡ELB和弹性伸缩AS服务。
	掌握在云平台部署高可用架构的方法。
3.2 配置应用开机启动
3.2.1 创建启动脚本
步骤 1	执行以下命令，创建启动脚本。
[root@ecs-oa oasys_mysql]# cd /home/
执行以下命令，创建脚本文件。
[root@ecs-oa home]# vim autostart.sh
步骤 2	执行以下命令，添加脚本代码。
脚本文件内容。
java -jar /home/oasys_mysql/target/oasys.jar

步骤 3	执行以下命令，为脚本添加可执行权限。
[root@ecs-oa home]# chmod +x autostart.sh
3.2.2 自定义开机启动命令
步骤 1	执行以下命令，进入系统目录，创建服务脚本。
[root@ecs-oa home]# cd /etc/systemd/system/
执行以下命令，创建脚本文件。
[root@ecs-oa system]# vim oa-service.service
脚本文件内容
[Unit] 
Description=Run autostart.sh script at startup 
After=network.target 

[Service] 
Type=simple 
ExecStart=/bin/bash /home/autostart.sh 
User=root 
Group=root 
Restart=on-failure 

[Install] 
WantedBy=multi-user.target
执行以下命令，为脚本添加可执行权限。
[root@ecs-oa system]# chmod +x oa-service.service
步骤 2	执行以下命令，添加开机启动服务。
[root@ecs-oa system]# systemctl daemon-reload
[root@ecs-oa system]# systemctl enable oa-service.service
3.2.3 验证开机启动
步骤 1	返回华为云控制台，点击“更多 -> 重启”，重启名为ecs-oa的云服务器。
 
步骤 2	等待1-2分钟，通过ecs-oa弹性公网IP地址加8088端口访问OA系统登录页，如http:// 121.36.103.164:8088/。使用用户名“soli”和密码“123456”登录进入OA系统主界面。
 
 
 
 

